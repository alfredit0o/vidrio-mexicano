{% extends "base.html" %}
{% block content %}
<style>
  :root{
    --ink:#e9eef7; --muted:#9aa3b2; --panel:#121418; --accent:#4cc9f0;
  }
  body{background:#0e0f12;color:var(--ink)}
  .wrap{max-width:560px;margin:10px auto;padding:8px}
  .title{margin:0 8px 4px}
  .hint{margin:0 8px 10px;color:var(--muted);text-align:center}

  .stage{
    position:relative;width:100%;
    height:clamp(360px,70vh,820px);
    background:#000;border-radius:14px;overflow:hidden;
    box-shadow:0 8px 24px rgba(0,0,0,.35)
  }
  video, img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  /* Canvas de dibujo va al tama√±o visible (suave) */
  #paint{ position:absolute; inset:0; width:100%; height:100%; touch-action:none; }

  .reticle{
    position:absolute;left:50%;top:50%;width:120px;height:120px;
    transform:translate(-50%,-50%);border:2px solid rgba(255,255,255,.7);
    border-radius:12px;pointer-events:none
  }
  .bar{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:10px;background:var(--panel);border-radius:12px;padding:8px}
  .btn{border:1px solid #2b3242;background:#0f1218;color:var(--ink);border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .shutter{width:56px;height:56px;border-radius:999px;border:4px solid #e9eef7;background:#e9eef7;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35)}
  .row{display:flex;gap:8px;margin:8px 0}
  .row input{flex:1;padding:10px;border-radius:10px;border:1px solid #2b3242;background:#0f1218;color:var(--ink)}
  .tools{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px;background:#11161f;border-radius:12px;padding:6px}
  .tool{padding:8px 10px;border-radius:10px;border:1px solid #2b3242;background:#0f1218;color:var(--ink);cursor:pointer;font-size:.95rem}
  .tool.active{outline:2px solid var(--accent)}
  .legend{color:var(--muted);font-size:.9rem;text-align:center;margin-top:6px}
</style>

<div class="wrap">
  <h2 class="title">Capturar medida ‚Äî l√≠neas rectas</h2>
  <p class="hint" id="status">Enmarca el vidrio y toca el bot√≥n.</p>

  <div class="stage" id="stage">
    <video id="video" autoplay playsinline muted></video>

    <!-- Fondo de la foto a resoluci√≥n completa (para exportar) -->
    <img id="photo" alt="captura" style="display:none" />

    <!-- Canvas ligero (del tama√±o visible) para anotar sin trabas -->
    <canvas id="paint"></canvas>

    <div class="reticle" id="reticle"></div>
  </div>

  <div class="row">
    <input type="text" id="nombre" placeholder="Nombre de la foto" />
  </div>

  <!-- Controles de c√°mara -->
  <div class="bar" id="cameraBar">
    <button class="btn" id="btnStart">Iniciar</button>
    <button class="shutter" id="btnShot" title="Tomar foto" disabled></button>
    <button class="btn" id="btnFlip" disabled>Cambiar c√°mara</button>
  </div>

  <!-- Herramientas (s√≥lo Cota, Texto, Borrar, Limpiar) -->
  <div id="editorArea" style="display:none">
    <div class="tools">
      <button class="tool" data-tool="dim">‚Üî Cota</button>
      <button class="tool" data-tool="text">T Texto</button>
      <button class="tool" data-tool="delete">üóëÔ∏è Borrar</button>
      <button class="tool" data-tool="clear">‚ü≤ Limpiar</button>
    </div>
    <p class="legend" id="legend">Cota: pulsa y arrastra (l√≠nea recta). Ajusta con los puntos. Doble toque para poner n√∫mero.</p>

    <div class="bar">
      <button class="btn" id="btnRetake">Repetir</button>
      <button class="btn" id="btnSave" disabled>Guardar</button>
    </div>
  </div>

  <form id="form" method="post" action="{{ url_for('medidas.new_post') }}" style="display:none">
    <input type="hidden" name="nombre"  id="campoNombre">
    <input type="hidden" name="dataurl" id="dataurl">
  </form>
</div>

<script>
/* ========= C√°mara ========= */
let stream=null, wakeLock=null, devices=[], envIds=[], userIds=[], currentList=[], idx=0, usingBack=true;
const $=id=>document.getElementById(id);
const video=$('video'), photo=$('photo'), paint=$('paint');
const btnStart=$('btnStart'), btnShot=$('btnShot'), btnFlip=$('btnFlip');
const btnRetake=$('btnRetake'), btnSave=$('btnSave');
const statusEl=$('status'), legendEl=$('legend');
const nombre=$('nombre'), campoNombre=$('campoNombre'), dataurl=$('dataurl'), form=$('form');
const cameraBar=$('cameraBar'), editorArea=$('editorArea');

function stopStream(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }
async function requestWakeLock(){ try{ if('wakeLock' in navigator){ wakeLock=await navigator.wakeLock.request('screen'); wakeLock.addEventListener('release',()=>{wakeLock=null}); } }catch(_){} }
async function enumerateCameras(){
  const list=await navigator.mediaDevices.enumerateDevices();
  devices=list.filter(d=>d.kind==='videoinput');
  envIds=[]; userIds=[];
  for(const d of devices){
    const L=d.label.toLowerCase();
    const isBack=L.includes('back')||L.includes('rear')||L.includes('environment');
    const isFront=L.includes('front')||L.includes('user');
    if(isBack) envIds.push(d.deviceId); else if(isFront) userIds.push(d.deviceId); else envIds.push(d.deviceId);
  }
  currentList=(usingBack&&envIds.length)?envIds:(userIds.length?userIds:devices.map(d=>d.deviceId));
  idx=0; btnFlip.disabled = devices.length<2; btnFlip.style.display=devices.length<2?'none':'inline-block';
}
async function startCameraById(deviceId){
  try{
    if(!navigator.mediaDevices?.getUserMedia){ alert('Requiere HTTPS o localhost'); return; }
    stopStream();
    const constraints={ video:{ deviceId:deviceId?{exact:deviceId}:undefined, facingMode: deviceId?undefined:{ideal:usingBack?'environment':'user'}, width:{ideal:1920}, height:{ideal:1080} }, audio:false };
    stream=await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject=stream; await video.play(); await requestWakeLock();
    resizePaintToDisplay();
    video.style.display='block'; photo.style.display='none';
    btnShot.disabled=false; statusEl.textContent='Enmarca el vidrio y toca el bot√≥n.';
  }catch(err){ console.error(err); alert('No se pudo iniciar la c√°mara: '+err.message); }
}
async function startCamera(){ await enumerateCameras(); const id=currentList[idx]||devices[0]?.deviceId||null; await startCameraById(id); }
btnStart.addEventListener('click', startCamera);
btnFlip.addEventListener('click', async ()=>{ if(!devices.length) await enumerateCameras(); idx=(idx+1)%currentList.length; await startCameraById(currentList[idx]); });

/* ========= Captura ‚Üí Editor ========= */
btnShot.addEventListener('click', async ()=>{
  if(!video.videoWidth){ alert('La c√°mara a√∫n no est√° lista.'); return; }
  const w=video.videoWidth, h=video.videoHeight;
  const c=document.createElement('canvas'); c.width=w; c.height=h;
  c.getContext('2d').drawImage(video,0,0,w,h);
  const png=c.toDataURL('image/png');

  photo.onload = ()=>{
    video.style.display='none';
    photo.style.display='block';
    cameraBar.style.display='none';
    editorArea.style.display='block';
    btnSave.disabled=false;

    resizePaintToDisplay();  // canvas suave al tama√±o visible
    initAnnotator();
    statusEl.textContent='Cota: arrastra recta. Ajusta con los puntos. Doble toque para n√∫mero.';
  };
  photo.src=png;

  stopStream(); if(wakeLock){ try{ await wakeLock.release(); }catch(_){} }
});

/* ========= Editor (l√≠neas rectas) ========= */
/** Guardamos las figuras en coords NORMALIZADAS (0-1) respecto a la imagen.
 *  Dibujamos y hacemos hit-test en coords de PANTALLA (r√°pido).
 *  Al guardar, escalamos a tama√±o real de la foto.
 */
let tool='dim', shapes=[], active=null, drag=null;
let dirty=true, rafId=null;

function setTool(t){
  tool=t;
  document.querySelectorAll('.tool').forEach(b=>b.classList.toggle('active', b.dataset.tool===t));
  if(legendEl){
    legendEl.textContent = (t==='dim')
      ? 'Cota: pulsa y arrastra para l√≠nea recta. Ajusta con puntas. Doble toque para poner n√∫mero.'
      : (t==='text' ? 'Toca para poner texto. Doble toque para editar; arrastra para mover.' :
        (t==='delete' ? 'Toca un elemento para borrarlo.' :
        ''));
  }
}

function resizePaintToDisplay(){
  // Canvas igual a tama√±o visible del contenedor (para suavidad)
  const r = paint.getBoundingClientRect();
  const dpr = Math.max(1, window.devicePixelRatio||1);
  paint.width = Math.floor(r.width * dpr);
  paint.height= Math.floor(r.height * dpr);
  paint.style.width = r.width + 'px';
  paint.style.height= r.height + 'px';
  markDirty();
}
window.addEventListener('resize', resizePaintToDisplay);

/* ---- utilidades ---- */
const ctx = ()=>paint.getContext('2d');
const DPR = ()=>Math.max(1, window.devicePixelRatio||1);
function markDirty(){ dirty=true; if(!rafId){ rafId=requestAnimationFrame(loop); } }
function loop(){ if(dirty){ draw(); dirty=false; } rafId=requestAnimationFrame(loop); }

function imgSize(){ return {w: photo.naturalWidth||1, h: photo.naturalHeight||1}; }
function displaySize(){ return {w: paint.width, h: paint.height}; }

// Normalizado <-> Pantalla
function n2s(p){ const {w,h}=displaySize(); return {x:p.x*w, y:p.y*h}; }
function s2n(p){ const {w,h}=displaySize(); return {x: p.x/w, y: p.y/h}; }

// Snapping: horizontal/vertical si el √°ngulo es cercano (¬±15¬∞)
function snapLine(a,b){
  const dx=b.x-a.x, dy=b.y-a.y;
  if(Math.abs(dx) < Math.abs(dy)*0.268){ // ~tan(15¬∞)
    // casi vertical -> dx ~ 0
    return {x:a.x, y:b.y};
  }else if(Math.abs(dy) < Math.abs(dx)*0.268){
    // casi horizontal -> dy ~ 0
    return {x:b.x, y:a.y};
  }
  return b; // libre
}

// M√©tricas en PANTALLA
function th(){
  const base=16*DPR();
  return {
    line: 3*DPR(),
    arrow: 10*DPR(),
    handle: 10*DPR(),
    hitPt2: (20*DPR())**2,
    hitSeg2:(24*DPR())**2,
    labelPad: 8*DPR(),
    labelH: 28*DPR(),
    labelRad: 6*DPR(),
    labelWmin: 64*DPR(),
    font: 16*DPR()
  };
}

/* ---- Dibujo (pantalla) ---- */
function draw(){
  const c=ctx(), {w,h}=displaySize(), T=th();
  c.clearRect(0,0,w,h);
  c.lineCap='round'; c.lineJoin='round'; c.lineWidth=T.line;
  c.strokeStyle='#ffe600'; c.fillStyle='#ffe600';
  c.font=`${T.font}px system-ui, -apple-system, Segoe UI, Roboto`;

  shapes.forEach(s=>{
    if(s.type==='dim'){
      const a=n2s(s.a), b=n2s(s.b);
      // l√≠nea
      c.beginPath(); c.moveTo(a.x,a.y); c.lineTo(b.x,b.y); c.stroke();
      // puntas
      arrow(c,a,b,T.arrow); arrow(c,b,a,T.arrow);
      // etiqueta si hay
      if(s.label && s.label.trim()){
        const m={x:(a.x+b.x)/2,y:(a.y+b.y)/2};
        drawLabel(c, m, s.label, T);
      }
      // handles grandes siempre visibles
      drawHandle(c,a,T.handle);
      drawHandle(c,b,T.handle);
    }else if(s.type==='text'){
      const p=n2s(s.pos);
      drawLabel(c, p, s.label||'Texto', T);
    }
  });
}
function arrow(c,p1,p2,size){
  const ang=Math.atan2(p2.y-p1.y,p2.x-p1.x);
  c.beginPath();
  c.moveTo(p1.x,p1.y);
  c.lineTo(p1.x+size*Math.cos(ang+Math.PI/6), p1.y+size*Math.sin(ang+Math.PI/6));
  c.moveTo(p1.x,p1.y);
  c.lineTo(p1.x+size*Math.cos(ang-Math.PI/6), p1.y+size*Math.sin(ang-Math.PI/6));
  c.stroke();
}
function drawHandle(c,p,r){
  c.save();
  c.fillStyle='#4cc9f0'; c.strokeStyle='#0c1724'; c.lineWidth=Math.max(1, r*0.2);
  c.beginPath(); c.arc(p.x,p.y,r,0,Math.PI*2); c.fill(); c.stroke();
  c.restore();
}
function drawLabel(c, center, text, T){
  const pad=T.labelPad;
  const w=Math.max(T.labelWmin, c.measureText(text).width + pad*2);
  const h=T.labelH;
  const x=center.x - w/2, y=center.y - h/2;
  roundRect(c, x,y,w,h, T.labelRad);
  c.fillStyle='#ffd400'; c.strokeStyle='#333'; c.lineWidth=1*DPR();
  c.fill(); c.stroke();
  c.fillStyle='#111'; c.textAlign='center'; c.textBaseline='middle';
  c.fillText(text, center.x, center.y);
  c.fillStyle='#ffe600'; // restore
  c.strokeStyle='#ffe600';
}
function roundRect(c,x,y,w,h,r){ c.beginPath(); c.moveTo(x+r,y); c.arcTo(x+w,y,x+w,y+h,r); c.arcTo(x+w,y+h,x,y+h,r); c.arcTo(x,y+h,x,y,r); c.arcTo(x,y,x+w,y,r); c.closePath(); }

/* ---- Hit test (pantalla) ---- */
function d2(p,q){ const dx=p.x-q.x, dy=p.y-q.y; return dx*dx+dy*dy; }
function dSeg2(p,a,b){
  const ax=b.x-a.x, ay=b.y-a.y, L=ax*ax+ay*ay; if(L===0) return d2(p,a);
  let t=((p.x-a.x)*ax + (p.y-a.y)*ay)/L; t=Math.max(0,Math.min(1,t));
  const q={x:a.x+t*ax, y:a.y+t*ay}; return d2(p,q);
}
function hitAt(p){ // p en pantalla
  const T=th();
  for(let i=shapes.length-1;i>=0;i--){
    const s=shapes[i];
    if(s.type==='dim'){
      const a=n2s(s.a), b=n2s(s.b);
      if(d2(p,a)<=T.hitPt2) return {i, part:'a'};
      if(d2(p,b)<=T.hitPt2) return {i, part:'b'};
      if(dSeg2(p,a,b)<=T.hitSeg2) return {i, part:'line'};
    }else if(s.type==='text'){
      const q=n2s(s.pos);
      const w=120*DPR(), h=40*DPR();
      if(Math.abs(p.x-q.x)<w/2 && Math.abs(p.y-q.y)<h/2) return {i, part:'text'};
    }
  }
  return null;
}

/* ---- Interacci√≥n ---- */
function initAnnotator(){
  shapes=[]; active=null; drag=null; dirty=true; if(!rafId) rafId=requestAnimationFrame(loop);
  setTool('dim');

  let lastTap=0;

  paint.addEventListener('pointerdown', e=>{
    paint.setPointerCapture?.(e.pointerId);
    const pS = toScreen(e);
    const pN = s2n(pS);
    const hit = hitAt(pS);

    // doble toque para editar
    const now=Date.now();
    if(now-lastTap<300 && hit){
      const s=shapes[hit.i];
      const val=prompt('Valor/etiqueta:', s.label||'');
      if(val!=null){ s.label=val; markDirty(); }
      lastTap=0; e.preventDefault(); return;
    }
    lastTap=now;

    if(tool==='delete'){ if(hit){ shapes.splice(hit.i,1); markDirty(); } return; }
    if(tool==='text'){ shapes.push({type:'text', pos:pN, label:'Texto'}); markDirty(); return; }

    // tool === 'dim'
    if(hit){
      drag={i:hit.i, mode:hit.part, startS:pS};
    }else{
      // Crear l√≠nea: recta con snap
      const id = (Date.now()+Math.random()).toString(36);
      shapes.push({type:'dim', a:pN, b:pN, label:''});
      drag={i:shapes.length-1, mode:'creating', startS:pS};
    }
    e.preventDefault();
  }, {passive:false});

  paint.addEventListener('pointermove', e=>{
    if(!drag) return;
    const pS = toScreen(e);
    const s = shapes[drag.i]; if(!s) { drag=null; return; }

    if(s.type==='dim'){
      if(drag.mode==='creating'){
        const aS=n2s(s.a), snapped = snapLine(aS, pS);
        s.b = s2n(snapped);
      }else if(drag.mode==='a'){
        const bS=n2s(s.b), snapped = snapLine(pS, bS); // snap a recta respecto a B
        s.a = s2n(snapped);
      }else if(drag.mode==='b'){
        const aS=n2s(s.a), snapped = snapLine(aS, pS);
        s.b = s2n(snapped);
      }else if(drag.mode==='line'){
        const dx = (pS.x - drag.startS.x), dy = (pS.y - drag.startS.y);
        const aS=n2s(s.a), bS=n2s(s.b);
        s.a = s2n({x:aS.x+dx, y:aS.y+dy});
        s.b = s2n({x:bS.x+dx, y:bS.y+dy});
        drag.startS = pS;
      }
    }else if(s.type==='text'){
      const qS=n2s(s.pos);
      const dx=pS.x - drag.startS.x, dy=pS.y - drag.startS.y;
      s.pos = s2n({x:qS.x+dx, y:qS.y+dy});
      drag.startS = pS;
    }
    markDirty();
    e.preventDefault();
  }, {passive:false});

  paint.addEventListener('pointerup', ()=>{ drag=null; });

  // Doble click (desktop)
  paint.addEventListener('dblclick', e=>{
    const hit=hitAt(toScreen(e)); if(!hit) return;
    const s=shapes[hit.i];
    const val=prompt('Valor/etiqueta:', s.label||'');
    if(val!=null){ s.label=val; markDirty(); }
  });
}

function toScreen(e){
  const r = paint.getBoundingClientRect();
  const dpr = DPR();
  const x = (e.clientX ?? e.touches?.[0]?.clientX ?? e.changedTouches?.[0]?.clientX) - r.left;
  const y = (e.clientY ?? e.touches?.[0]?.clientY ?? e.changedTouches?.[0]?.clientY) - r.top;
  return { x: x*dpr, y: y*dpr };
}

/* ========= Guardar (exporta en tama√±o real) ========= */
btnRetake.addEventListener('click', async ()=>{
  editorArea.style.display='none'; cameraBar.style.display='flex';
  await startCamera();
});
btnSave.addEventListener('click', ()=>{
  if(!nombre.value.trim()){ alert('Pon un nombre a la foto.'); return; }
  const {w,h}=imgSize();
  const out=document.createElement('canvas'); out.width=w; out.height=h;
  const c=out.getContext('2d');
  const img=new Image(); img.onload=()=>{
    c.drawImage(img,0,0,w,h);
    // dibuja anotaciones escaladas al tama√±o real
    c.lineCap='round'; c.lineJoin='round';
    c.strokeStyle='#ffe600'; c.fillStyle='#ffe600';
    c.lineWidth = Math.max(2, Math.round(Math.min(w,h)*0.003)); // grosor relativo

    const fontSize = Math.max(14, Math.round(Math.min(w,h)*0.02));
    c.font = `${fontSize}px system-ui, -apple-system, Segoe UI, Roboto`;

    shapes.forEach(s=>{
      if(s.type==='dim'){
        const a={x:s.a.x*w, y:s.a.y*h}, b={x:s.b.x*w, y:s.b.y*h};
        c.beginPath(); c.moveTo(a.x,a.y); c.lineTo(b.x,b.y); c.stroke();
        // flechas
        arrow(c,a,b, Math.max(8, fontSize*0.6));
        arrow(c,b,a, Math.max(8, fontSize*0.6));
        if(s.label && s.label.trim()){
          const m={x:(a.x+b.x)/2, y:(a.y+b.y)/2};
          drawLabelExport(c, m, s.label, fontSize);
        }
      }else if(s.type==='text'){
        const p={x:s.pos.x*w, y:s.pos.y*h};
        drawLabelExport(c, p, s.label||'Texto', fontSize);
      }
    });

    const png=out.toDataURL('image/png');
    dataurl.value=png; campoNombre.value=nombre.value.trim(); form.submit();
  };
  img.src=photo.src;
});

function drawLabelExport(c, center, text, fontSize){
  const pad = Math.round(fontSize*0.5);
  const h   = Math.round(fontSize*1.6);
  const w   = Math.max(Math.round(fontSize*4), Math.round(c.measureText(text).width + pad*2));
  const x=center.x - w/2, y=center.y - h/2;
  roundRect(c, x,y,w,h, Math.round(fontSize*0.35));
  c.fillStyle='#ffd400'; c.strokeStyle='#333'; c.lineWidth=2;
  c.fill(); c.stroke();
  c.fillStyle='#111'; c.textAlign='center'; c.textBaseline='middle';
  c.fillText(text, center.x, center.y);
  c.fillStyle='#ffe600'; c.strokeStyle='#ffe600';
}

/* ========= Limpieza / Auto ========= */
window.addEventListener('beforeunload', ()=>stopStream());
document.addEventListener('DOMContentLoaded', ()=>{ resizePaintToDisplay(); startCamera().catch(()=>{}); });
</script>
{% endblock %}
