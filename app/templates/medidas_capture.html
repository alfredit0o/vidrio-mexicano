{% extends "base.html" %}
{% block content %}
<style>
  :root{
    --ink:#e9eef7; --muted:#9aa3b2; --panel:#121418; --panel2:#191e28; --accent:#4cc9f0;
  }
  body{background:#0e0f12;color:var(--ink)}
  .wrap{max-width:560px;margin:10px auto;padding:8px}
  .title{margin:0 8px 4px}
  .hint{margin:0 8px 10px;color:var(--muted);text-align:center}

  /* M√°s imagen: alto din√°mico */
  .stage{
    position:relative;width:100%;
    height:clamp(360px,70vh,820px);
    background:#000;border-radius:14px;overflow:hidden;
    box-shadow:0 8px 24px rgba(0,0,0,.35)
  }
  video, img, canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}

  /* Z-index correcto: foto debajo, canvas encima */
  #photo{ touch-action:none; z-index:1; }
  #paint{ touch-action:none; z-index:2; }

  .reticle{
    position:absolute;left:50%;top:50%;width:120px;height:120px;
    transform:translate(-50%,-50%);border:2px solid rgba(255,255,255,.7);
    border-radius:12px;pointer-events:none
  }
  .bar{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:10px;background:var(--panel);border-radius:12px;padding:8px}
  .btn{border:1px solid #2b3242;background:#0f1218;color:var(--ink);border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .shutter{width:56px;height:56px;border-radius:999px;border:4px solid #e9eef7;background:#e9eef7;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35)}
  .row{display:flex;gap:8px;margin:8px 0}
  .row input{flex:1;padding:10px;border-radius:10px;border:1px solid #2b3242;background:#0f1218;color:var(--ink)}
  .tools{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px;background:#11161f;border-radius:12px;padding:6px}
  .tool{padding:8px 10px;border-radius:10px;border:1px solid #2b3242;background:#0f1218;color:var(--ink);cursor:pointer;font-size:.95rem}
  .tool.active{outline:2px solid var(--accent)}
  .legend{color:var(--muted);font-size:.9rem;text-align:center;margin-top:6px}
</style>

<div class="wrap">
  <h2 class="title">Capturar medida ‚Äî v2.6</h2>
  <p class="hint" id="status">Enmarca el vidrio y toca el bot√≥n.</p>

  <div class="stage" id="stage">
    <video id="video" autoplay playsinline muted></video>

    <!-- Capa de zoom (dos dedos) -->
    <div id="zoomLayer" style="position:absolute; inset:0; touch-action:none; transform-origin:center center;">
      <img id="photo" alt="captura" style="display:none; width:100%; height:100%; object-fit:cover" />
      <canvas id="paint" style="display:none"></canvas>
    </div>

    <div class="reticle" id="reticle"></div>
  </div>

  <div class="row">
    <input type="text" id="nombre" placeholder="Nombre de la foto" />
  </div>

  <!-- Controles de c√°mara -->
  <div class="bar" id="cameraBar">
    <button class="btn" id="btnStart">Iniciar</button>
    <button class="shutter" id="btnShot" title="Tomar foto" disabled></button>
    <button class="btn" id="btnFlip" disabled>Cambiar c√°mara</button>
  </div>

  <!-- Herramientas (Flecha, Texto, Borrar, Limpiar) -->
  <div id="editorArea" style="display:none">
    <div class="tools">
      <button class="tool" data-tool="dim">‚Üî Flecha</button>
      <button class="tool" data-tool="text">T Texto</button>
      <button class="tool" data-tool="delete">üóëÔ∏è Borrar</button>
      <button class="tool" data-tool="clear">‚ü≤ Limpiar</button>
    </div>
    <p class="legend" id="legend">‚Üî Arrastra para crear la cota. Mueve puntas o la l√≠nea. Doble toque / mantener para editar.</p>

    <div class="bar">
      <button class="btn" id="btnRetake">Repetir</button>
      <button class="btn" id="btnSave" disabled>Guardar</button>
    </div>
  </div>

  <form id="form" method="post" action="{{ url_for('medidas.new_post') }}" style="display:none">
    <input type="hidden" name="nombre"  id="campoNombre">
    <input type="hidden" name="dataurl" id="dataurl">
  </form>
</div>

<script>
  /* ====== C√°mara (igual que antes) ====== */
  let stream=null, wakeLock=null, devices=[], envIds=[], userIds=[], currentList=[], idx=0, usingBack=true;
  const $=id=>document.getElementById(id);
  const video=$('video'), photo=$('photo'), paint=$('paint'), zoomLayer=$('zoomLayer');
  const btnStart=$('btnStart'), btnShot=$('btnShot'), btnFlip=$('btnFlip');
  const btnRetake=$('btnRetake'), btnSave=$('btnSave');
  const statusEl=$('status'), legendEl=$('legend');
  const nombre=$('nombre'), campoNombre=$('campoNombre'), dataurl=$('dataurl'), form=$('form');
  const cameraBar=$('cameraBar'), editorArea=$('editorArea');
  
  function stopStream(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }
  async function requestWakeLock(){ try{ if('wakeLock' in navigator){ wakeLock=await navigator.wakeLock.request('screen'); wakeLock.addEventListener('release',()=>{wakeLock=null}); } }catch(_){} }
  async function enumerateCameras(){
    const list=await navigator.mediaDevices.enumerateDevices();
    devices=list.filter(d=>d.kind==='videoinput');
    envIds=[]; userIds=[];
    for(const d of devices){
      const L=d.label.toLowerCase();
      const isBack=L.includes('back')||L.includes('rear')||L.includes('environment');
      const isFront=L.includes('front')||L.includes('user');
      if(isBack) envIds.push(d.deviceId); else if(isFront) userIds.push(d.deviceId); else envIds.push(d.deviceId);
    }
    currentList=(usingBack&&envIds.length)?envIds:(userIds.length?userIds:devices.map(d=>d.deviceId));
    idx=0;
    btnFlip.disabled = devices.length<2; btnFlip.style.display=devices.length<2?'none':'inline-block';
  }
  async function startCameraById(deviceId){
    try{
      if(!navigator.mediaDevices?.getUserMedia){ alert('Requiere HTTPS o localhost'); return; }
      stopStream();
      const constraints={ video:{ deviceId:deviceId?{exact:deviceId}:undefined, facingMode: deviceId?undefined:{ideal:usingBack?'environment':'user'}, width:{ideal:1920}, height:{ideal:1080} }, audio:false };
      stream=await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject=stream; await video.play(); await requestWakeLock();
      video.style.display='block'; photo.style.display='none'; paint.style.display='none';
      btnShot.disabled=false; statusEl.textContent='Enmarca el vidrio y toca el bot√≥n.';
    }catch(err){ console.error(err); alert('No se pudo iniciar la c√°mara: '+err.message); }
  }
  async function startCamera(){ await enumerateCameras(); const id=currentList[idx]||devices[0]?.deviceId||null; await startCameraById(id); }
  btnStart.addEventListener('click', startCamera);
  btnFlip.addEventListener('click', async ()=>{ if(!devices.length) await enumerateCameras(); idx=(idx+1)%currentList.length; await startCameraById(currentList[idx]); });
  
  /* ====== Captura ‚Üí Editor (espera onload) ====== */
  btnShot.addEventListener('click', async ()=>{
    if(!video.videoWidth){ alert('La c√°mara a√∫n no est√° lista.'); return; }
    const w=video.videoWidth, h=video.videoHeight;
    const c=document.createElement('canvas'); c.width=w; c.height=h;
    c.getContext('2d').drawImage(video,0,0,w,h);
    const png=c.toDataURL('image/png');
  
    photo.onload = ()=>{
      paint.width = photo.naturalWidth;
      paint.height= photo.naturalHeight;
      paint.style.display='block';
      photo.style.display='block';
      video.style.display='none';
      cameraBar.style.display='none';
      editorArea.style.display='block';
      btnSave.disabled=false;
      statusEl.textContent='‚Üî Arrastra para crear. Toca l√≠nea/etiqueta para mover. Doble toque para editar.';
      initAnnotator();
    };
    photo.src=png;
  
    stopStream(); if(wakeLock){ try{ await wakeLock.release(); }catch(_){} }
  });
  
  /* ====== Editor (Flecha + Texto) ====== */
  let tool='dim', shapes=[], activeId=null, dragMode=null, dragStart=null;
  let dirty = true;           // bandera de dibujo
  let fontPx = 20;            // cacheado (se recalcula al dibujar)
  function markDirty(){ dirty = true; }
  
  /* --- utilidades dependientes de pantalla --- */
  function pxToCanvas(px){
    const r = paint.getBoundingClientRect();
    const sx = paint.width / r.width;
    return px * sx;
  }
  const T = { pt:24, seg:28, labelW:160, labelH:48, handleR:12, line:4 }; // en px CSS
  function TT(){ // thresholds en px Canvas
    return {
      pt: pxToCanvas(T.pt),
      seg: pxToCanvas(T.seg),
      labelW: pxToCanvas(T.labelW),
      labelH: pxToCanvas(T.labelH),
      handleR: pxToCanvas(T.handleR),
      line: Math.max(6, pxToCanvas(T.line)),
      arrow: pxToCanvas(12),
      labelPad: pxToCanvas(8),
      labelRad: pxToCanvas(8),
      labelStroke: pxToCanvas(2),
      handleStroke: pxToCanvas(2),
      font: pxToCanvas(fontPx)
    };
  }
  
  function setLegend(){
    const map={
      dim:'‚Üî Crear: arrastra. Mover: toca l√≠nea/etiqueta y arrastra. Ajustar: arrastra puntas. Editar: doble toque.',
      text:'Toca para colocar texto. Mover arrastrando. Editar: doble toque.',
      delete:'Toca para borrar.',
      clear:'Limpia todas las anotaciones.'
    };
    (legendEl||{}).textContent = map[tool]||'';
  }
  function setTool(t){
    tool=t;
    document.querySelectorAll('.tool').forEach(b=>b.classList.toggle('active', b.dataset.tool===t));
    setLegend();
  }
  document.querySelectorAll('.tool').forEach(b=>{
    b.addEventListener('click', ()=>{
      const t=b.dataset.tool;
      if(t==='clear'){ shapes=[]; markDirty(); return; }
      setTool(t);
    });
  });
  setTool('dim');
  
  function cx(){ return paint.getContext('2d'); }
  function toCanvasPos(e){
    const r = paint.getBoundingClientRect();
    const x = (e.clientX ?? e.touches?.[0]?.clientX ?? e.changedTouches?.[0]?.clientX) - r.left;
    const y = (e.clientY ?? e.touches?.[0]?.clientY ?? e.changedTouches?.[0]?.clientY) - r.top;
    const sx = paint.width / r.width, sy = paint.height / r.height;
    return { x: x*sx, y: y*sy };
  }
  
  /* ---- dibujo (s√≥lo cuando dirty) ---- */
  function draw(){
    const ctx=cx(); const th=TT();
    ctx.clearRect(0,0,paint.width,paint.height);
    ctx.lineCap='round'; ctx.lineJoin='round';
    ctx.lineWidth=th.line;
    ctx.strokeStyle='#ffe600'; ctx.fillStyle='#ffe600';
    ctx.font=`${th.font}px system-ui, -apple-system, Segoe UI, Roboto`;
    shapes.forEach(s=>{
      if(s.type==='dim'){
        const {a,b}=s;
        ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
        drawArrow(ctx,a,b, th); drawArrow(ctx,b,a, th);
        if(s.label && s.label.trim()) drawLabel(ctx, mid(a,b), s.label, th);
        drawHandle(ctx,a, th); drawHandle(ctx,b, th); // SIEMPRE visibles (sin hover)
      } else if(s.type==='text'){
        drawLabel(ctx,s.pos, s.label || 'Texto', th);
      }
    });
  }
  function drawArrow(ctx, p1, p2, th){
    const ang=Math.atan2(p2.y-p1.y,p2.x-p1.x), size=th.arrow;
    ctx.beginPath();
    ctx.moveTo(p1.x,p1.y);
    ctx.lineTo(p1.x+size*Math.cos(ang+Math.PI/6), p1.y+size*Math.sin(ang+Math.PI/6));
    ctx.moveTo(p1.x,p1.y);
    ctx.lineTo(p1.x+size*Math.cos(ang-Math.PI/6), p1.y+size*Math.sin(ang-Math.PI/6));
    ctx.stroke();
  }
  function drawLabel(ctx, pos, text, th){
    const pad=th.labelPad, t=text||'';
    const w=ctx.measureText(t).width+pad*2, h=pxToCanvas(34);
    const x=pos.x-w/2, y=pos.y-h/2;
    ctx.fillStyle='#ffd400'; ctx.strokeStyle='#333'; ctx.lineWidth=th.labelStroke;
    roundRect(ctx,x,y,w,h, th.labelRad); ctx.fill(); ctx.stroke();
    ctx.fillStyle='#111'; ctx.textBaseline='middle'; ctx.textAlign='center';
    ctx.fillText(t, x+w/2, y+h/2);
    ctx.fillStyle='#ffe600'; // restaurar
    ctx.strokeStyle='#ffe600';
  }
  function drawHandle(ctx, p, th){
    ctx.save();
    ctx.fillStyle='#4cc9f0'; ctx.strokeStyle='#0c1724'; ctx.lineWidth=th.handleStroke;
    ctx.beginPath(); ctx.arc(p.x,p.y,th.handleR,0,Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.restore();
  }
  function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
  function mid(a,b){ return {x:(a.x+b.x)/2, y:(a.y+b.y)/2}; }
  
  /* ---- hit test optimizado ---- */
  function dist2(p,q){ const dx=p.x-q.x, dy=p.y-q.y; return dx*dx+dy*dy; }
  function distSeg2(p,a,b){
    const ax=b.x-a.x, ay=b.y-a.y;
    const len2=ax*ax+ay*ay; if(len2===0) return dist2(p,a);
    let t=((p.x-a.x)*ax + (p.y-a.y)*ay)/len2; t=Math.max(0,Math.min(1,t));
    const q={x:a.x+t*ax, y:a.y+t*ay};
    return dist2(p,q);
  }
  function hitTest(p){
    const th=TT(); const pt2=th.pt*th.pt, seg2=th.seg*th.seg;
    for(let i=shapes.length-1;i>=0;i--){
      const s=shapes[i];
      if(s.type==='dim'){
        if(dist2(p,s.a)<pt2) return {id:s.id, part:'a'};
        if(dist2(p,s.b)<pt2) return {id:s.id, part:'b'};
        if(distSeg2(p,s.a,s.b)<seg2) return {id:s.id, part:'line'};
        if(s.label && s.label.trim()){
          const m = mid(s.a,s.b), hw=th.labelW/2, hh=th.labelH/2;
          if(p.x>=m.x-hw && p.x<=m.x+hw && p.y>=m.y-hh && p.y<=m.y+hh) return {id:s.id, part:'line'};
        }
      }else if(s.type==='text'){
        const hw=th.labelW/2, hh=th.labelH/2;
        if(Math.abs(p.x-s.pos.x)<hw && Math.abs(p.y-s.pos.y)<hh) return {id:s.id, part:'text'};
      }
    }
    return null;
  }
  
  /* ---- interacci√≥n ---- */
  let dragInfo=null; // {id, mode, start:{x,y}}
  function initAnnotator(){
    shapes=[]; activeId=null; dragMode=null; dragStart=null; dragInfo=null;
    markDirty(); setTool('dim');
  
    let lastTap=0;
  
    const editAt=(p)=>{
      const hit=hitTest(p); if(!hit) return;
      const s=shapes.find(x=>x.id===hit.id); if(!s) return;
      const v=prompt('Valor/etiqueta:', s.label||''); if(v!=null){ s.label=v; markDirty(); }
    };
  
    const onDown=(e)=>{
      if(gesture.active) return;
      paint.setPointerCapture?.(e.pointerId);
      const p=toCanvasPos(e);
      const hit=hitTest(p);
  
      // doble-tap
      const now=Date.now();
      if(now-lastTap<300 && hit){ editAt(p); lastTap=0; e.preventDefault(); return; }
      lastTap=now;
  
      if(tool==='delete'){ if(hit){ shapes=shapes.filter(s=>s.id!==hit.id); markDirty(); } return; }
      if(tool==='text'){ shapes.push({id:(Date.now()+Math.random()).toString(36), type:'text', pos:p, label:'Texto'}); markDirty(); return; }
  
      if(hit){
        dragInfo={ id:hit.id, mode:hit.part, start:p };
      }else{
        // crear nueva cota
        const id=(Date.now()+Math.random()).toString(36);
        shapes.push({id, type:'dim', a:p, b:p, label:''});
        dragInfo={ id, mode:'creating', start:p };
      }
      e.preventDefault();
    };
  
    const onMove=(e)=>{
      if(!dragInfo || gesture.active) return;
      const p=toCanvasPos(e);
      const s=shapes.find(x=>x.id===dragInfo.id); if(!s){ dragInfo=null; return; }
  
      if(s.type==='dim'){
        if(dragInfo.mode==='creating'){ s.b=p; }
        else if(dragInfo.mode==='a'){ s.a=p; }
        else if(dragInfo.mode==='b'){ s.b=p; }
        else if(dragInfo.mode==='line'){
          const dx=p.x-dragInfo.start.x, dy=p.y-dragInfo.start.y;
          s.a.x+=dx; s.a.y+=dy; s.b.x+=dx; s.b.y+=dy;
          dragInfo.start=p;
        }
      }else if(s.type==='text'){
        const dx=p.x-dragInfo.start.x, dy=p.y-dragInfo.start.y;
        s.pos.x+=dx; s.pos.y+=dy; dragInfo.start=p;
      }
      markDirty(); e.preventDefault();
    };
  
    const onUp=()=>{ dragInfo=null; };
  
    paint.addEventListener('pointerdown', onDown, {passive:false});
    paint.addEventListener('pointermove', onMove,  {passive:false});
    paint.addEventListener('pointerup',   onUp,    {passive:false});
    paint.addEventListener('pointerleave',onUp,    {passive:false});
  
    // Doble click (desktop)
    paint.addEventListener('dblclick', (e)=>{ editAt(toCanvasPos(e)); });
  
    // Iniciar loop de render una sola vez por init
    (function loop(){ if(dirty){ draw(); dirty=false; } requestAnimationFrame(loop); })();
  }
  
  /* ====== Pinch-to-zoom (dos dedos) ====== */
  const gesture = { active:false, scale:1, tx:0, ty:0, startDist:0, startCx:0, startCy:0, startTx:0, startTy:0, startScale:1 };
  const pointers = new Map();
  function setTransform(){ zoomLayer.style.willChange='transform'; zoomLayer.style.transform = `translate(${gesture.tx}px, ${gesture.ty}px) scale(${gesture.scale})`; }
  zoomLayer.addEventListener('pointerdown', (e)=>{ zoomLayer.setPointerCapture(e.pointerId); pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
    if(pointers.size===2){ const [p1,p2]=[...pointers.values()]; gesture.active=true;
      gesture.startDist=Math.hypot(p2.x-p1.x,p2.y-p1.y);
      gesture.startCx=(p1.x+p2.x)/2; gesture.startCy=(p1.y+p2.y)/2;
      gesture.startTx=gesture.tx; gesture.startTy=gesture.ty; gesture.startScale=gesture.scale; }
  });
  zoomLayer.addEventListener('pointermove', (e)=>{ if(!pointers.has(e.pointerId)) return; pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
    if(gesture.active && pointers.size===2){ const [p1,p2]=[...pointers.values()];
      const dist=Math.hypot(p2.x-p1.x,p2.y-p1.y), cx=(p1.x+p2.x)/2, cy=(p1.y+p2.y)/2;
      const ds=dist/gesture.startDist;
      gesture.scale=Math.min(3,Math.max(1,gesture.startScale*ds));
      gesture.tx=gesture.startTx+(cx-gesture.startCx); gesture.ty=gesture.startTy+(cy-gesture.startCy);
      setTransform(); }
  },{passive:false});
  function endPointer(e){ pointers.delete(e.pointerId); if(pointers.size<2){ gesture.active=false; } }
  zoomLayer.addEventListener('pointerup', endPointer);
  zoomLayer.addEventListener('pointercancel', endPointer);
  zoomLayer.addEventListener('pointerleave', endPointer);
  
  /* ====== Repetir / Guardar ====== */
  btnRetake.addEventListener('click', async ()=>{
    editorArea.style.display='none'; cameraBar.style.display='flex';
    gesture.scale=1; gesture.tx=0; gesture.ty=0; setTransform();
    await startCamera();
  });
  btnSave.addEventListener('click', ()=>{
    if(!nombre.value.trim()){ alert('Pon un nombre a la foto.'); return; }
    const w=photo.naturalWidth, h=photo.naturalHeight;
    const out=document.createElement('canvas'); out.width=w; out.height=h;
    const ctx=out.getContext('2d');
    const img=new Image(); img.onload=()=>{
      ctx.drawImage(img,0,0,w,h);
      ctx.drawImage(paint,0,0);
      const png=out.toDataURL('image/png');
      dataurl.value=png; campoNombre.value=nombre.value.trim(); form.submit();
    }; img.src=photo.src;
  });
  
  /* Limpieza */
  window.addEventListener('pagehide', stopStream);
  window.addEventListener('beforeunload', stopStream);
  
  /* Autoinicio */
  document.addEventListener('DOMContentLoaded', ()=>{ startCamera().catch(()=>{}); });
  </script>
  

  
{% endblock %}
