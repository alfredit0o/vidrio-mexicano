{% extends "base.html" %}
{% block content %}
<style>
  :root{
    --ink:#e9eef7; --muted:#9aa3b2; --panel:#121418; --panel2:#191e28; --accent:#4cc9f0;
    --label:#ffd400; --labelText:#111;
  }
  body{background:#0e0f12;color:var(--ink)}
  .wrap{max-width:560px;margin:16px auto;padding:8px}
  .title{margin:0 8px 6px}
  .hint{margin:0 8px 12px;color:var(--muted);text-align:center}
  .stage{position:relative;width:100%;aspect-ratio:4/3;background:#000;border-radius:14px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.35)}
  video, img, canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .reticle{position:absolute;left:50%;top:50%;width:140px;height:140px;transform:translate(-50%,-50%);border:2px solid rgba(255,255,255,.85);border-radius:14px;pointer-events:none}
  .bar{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:12px;background:var(--panel);border-radius:14px;padding:10px}
  .btn{border:1px solid #2b3242;background:#0f1218;color:var(--ink);border-radius:12px;padding:10px 14px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .shutter{width:64px;height:64px;border-radius:999px;border:4px solid #e9eef7;background:#e9eef7;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35)}
  .row{display:flex;gap:8px;margin:10px 0}
  .row input{flex:1;padding:10px;border-radius:10px;border:1px solid #2b3242;background:#0f1218;color:var(--ink)}
  .tools{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px;background:var(--panel2);border-radius:14px;padding:8px}
  .tool{padding:8px 10px;border-radius:10px;border:1px solid #2b3242;background:#0f1218;color:var(--ink);cursor:pointer;font-size:.95rem}
  .tool.active{outline:2px solid var(--accent)}
  .legend{color:var(--muted);font-size:.9rem;text-align:center;margin-top:6px}
</style>

<div class="wrap">
  <h2 class="title">Capturar medida ‚Äî v2.2</h2>
  <p class="hint" id="status">Enmarca el vidrio y toca el bot√≥n.</p>

  <div class="stage" id="stage">
    <video id="video" autoplay playsinline muted></video>

    <!-- Capa de zoom (dos dedos) que envuelve foto + canvas -->
    <div id="zoomLayer" style="position:absolute; inset:0; touch-action:none; transform-origin:center center;">
      <img id="photo" alt="captura" style="display:none; width:100%; height:100%; object-fit:cover" />
      <canvas id="paint" style="display:none"></canvas>
    </div>

    <div class="reticle" id="reticle"></div>
  </div>

  <div class="row">
    <input type="text" id="nombre" placeholder="Nombre de la foto" />
  </div>

  <!-- Controles de c√°mara -->
  <div class="bar" id="cameraBar">
    <button class="btn" id="btnStart">Iniciar</button>
    <button class="shutter" id="btnShot" title="Tomar foto" disabled></button>
    <button class="btn" id="btnFlip" disabled>Cambiar c√°mara</button>
  </div>

  <!-- Herramientas (solo Flecha, Texto, Borrar, Limpiar) -->
  <div id="editorArea" style="display:none">
    <div class="tools">
      <button class="tool" data-tool="dim">‚Üî Flecha</button>
      <button class="tool" data-tool="text">T Texto</button>
      <button class="tool" data-tool="delete">üóëÔ∏è Borrar</button>
      <button class="tool" data-tool="clear">‚ü≤ Limpiar</button>
    </div>
    <p class="legend" id="legend">‚Üî Arrastra para crear la flecha. Doble toque para editar la etiqueta.</p>

    <div class="bar">
      <button class="btn" id="btnRetake">Repetir</button>
      <button class="btn" id="btnSave" disabled>Guardar</button>
    </div>
  </div>

  <form id="form" method="post" action="{{ url_for('medidas.new_post') }}" style="display:none">
    <input type="hidden" name="nombre"  id="campoNombre">
    <input type="hidden" name="dataurl" id="dataurl">
  </form>
</div>

<script>
/* ====== C√°mara (una sola activa) ====== */
let stream=null, wakeLock=null, devices=[], envIds=[], userIds=[], currentList=[], idx=0, usingBack=true;
const $=id=>document.getElementById(id);
const video=$('video'), photo=$('photo'), paint=$('paint'), zoomLayer=$('zoomLayer');
const btnStart=$('btnStart'), btnShot=$('btnShot'), btnFlip=$('btnFlip');
const btnRetake=$('btnRetake'), btnSave=$('btnSave');
const statusEl=$('status'), legendEl=$('legend');
const nombre=$('nombre'), campoNombre=$('campoNombre'), dataurl=$('dataurl'), form=$('form');
const cameraBar=$('cameraBar'), editorArea=$('editorArea');

function stopStream(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }
async function requestWakeLock(){ try{ if('wakeLock' in navigator){ wakeLock=await navigator.wakeLock.request('screen'); wakeLock.addEventListener('release',()=>{wakeLock=null}); } }catch(_){} }
async function enumerateCameras(){
  const list=await navigator.mediaDevices.enumerateDevices();
  devices=list.filter(d=>d.kind==='videoinput');
  envIds=[]; userIds=[];
  for(const d of devices){
    const isBack=d.label.toLowerCase().includes('back')||d.label.toLowerCase().includes('rear');
    const isFront=d.label.toLowerCase().includes('front');
    if(isBack) envIds.push(d.deviceId); else if(isFront) userIds.push(d.deviceId); else envIds.push(d.deviceId);
  }
  currentList=(usingBack&&envIds.length)?envIds:(userIds.length?userIds:devices.map(d=>d.deviceId));
  idx=0;
  btnFlip.disabled = devices.length<2; btnFlip.style.display=devices.length<2?'none':'inline-block';
}
async function startCameraById(deviceId){
  try{
    if(!navigator.mediaDevices?.getUserMedia){ alert('Requiere HTTPS o localhost'); return; }
    stopStream();
    const constraints={ video:{ deviceId:deviceId?{exact:deviceId}:undefined, facingMode: deviceId?undefined:{ideal:usingBack?'environment':'user'}, width:{ideal:1920}, height:{ideal:1080} }, audio:false };
    stream=await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject=stream; await video.play(); await requestWakeLock();
    video.style.display='block'; photo.style.display='none'; paint.style.display='none';
    btnShot.disabled=false; statusEl.textContent='Enmarca el vidrio y toca el bot√≥n.';
  }catch(err){ console.error(err); alert('No se pudo iniciar la c√°mara: '+err.message); }
}
async function startCamera(){ await enumerateCameras(); const id=currentList[idx]||devices[0]?.deviceId||null; await startCameraById(id); }

btnStart.addEventListener('click', startCamera);
btnFlip.addEventListener('click', async ()=>{ if(!devices.length) await enumerateCameras(); idx=(idx+1)%currentList.length; await startCameraById(currentList[idx]); });

/* ====== Captura ‚Üí Editor ====== */
btnShot.addEventListener('click', async ()=>{
  if(!video.videoWidth){ alert('La c√°mara a√∫n no est√° lista.'); return; }
  const w=video.videoWidth, h=video.videoHeight;
  const tmp=document.createElement('canvas'); tmp.width=w; tmp.height=h;
  tmp.getContext('2d').drawImage(video,0,0,w,h);
  const png=tmp.toDataURL('image/png');
  photo.src=png;

  // prepara editor
  paint.width=w; paint.height=h;
  paint.style.display='block'; photo.style.display='block';
  video.style.display='none'; cameraBar.style.display='none'; editorArea.style.display='block';
  btnSave.disabled=false;

  stopStream(); if(wakeLock){ try{ await wakeLock.release(); }catch(_){} }
  statusEl.textContent='Arrastra para medir. Doble toque para editar valor.';
  initAnnotator();
});

/* ====== Editor (Flecha + Texto) ====== */
let tool='dim', shapes=[], activeId=null, dragStart=null, hoverId=null;

function setLegend(){
  const map={
    dim:'‚Üî Arrastra para crear la flecha. Doble toque para editar la etiqueta.',
    text:'Toca para colocar texto.',
    delete:'Toca un elemento para borrarlo.',
    clear:'Limpia todas las anotaciones.'
  };
  legendEl.textContent=map[tool]||'';
}
function setTool(t){
  tool=t;
  document.querySelectorAll('.tool').forEach(b=>b.classList.toggle('active', b.dataset.tool===t));
  setLegend();
}
document.querySelectorAll('.tool').forEach(b=>{
  b.addEventListener('click', ()=>{
    const t=b.dataset.tool;
    if(t==='clear'){ shapes=[]; draw(); return; }
    setTool(t);
  });
});
setTool('dim');

function cx(){ return paint.getContext('2d'); }
function toCanvasPos(evt){
  const r=paint.getBoundingClientRect();
  const client = evt.touches ? evt.touches[0] : (evt.changedTouches ? evt.changedTouches[0] : evt);
  const x=(client.clientX)-r.left, y=(client.clientY)-r.top;
  const sx=paint.width/r.width, sy=paint.height/r.height;
  return {x:x*sx, y:y*sy};
}

function draw(){
  const ctx=cx(); ctx.clearRect(0,0,paint.width,paint.height);
  shapes.forEach(s=>{
    ctx.save();
    ctx.lineWidth=4; ctx.strokeStyle='#ffe600'; ctx.fillStyle='#ffe600';
    ctx.font='32px system-ui, -apple-system, Segoe UI, Roboto';
    if(s.type==='dim'){
      const {a,b}=s;
      ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
      drawArrow(ctx,a,b); drawArrow(ctx,b,a);
      drawLabel(ctx, mid(a,b), s.label||'');
    }else if(s.type==='text'){
      drawLabel(ctx,s.pos,s.label||'Texto');
    }
    ctx.restore();
  });
  if(hoverId!=null){
    const s=shapes.find(x=>x.id===hoverId); if(!s) return;
    const ctx=cx(); ctx.save(); ctx.strokeStyle='#4cc9f0'; ctx.lineWidth=3;
    if(s.type==='dim'){ ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke(); }
    ctx.restore();
  }
}
function drawArrow(ctx, p1, p2){
  const ang=Math.atan2(p2.y-p1.y,p2.x-p1.x), size=14;
  ctx.beginPath();
  ctx.moveTo(p1.x,p1.y);
  ctx.lineTo(p1.x+size*Math.cos(ang+Math.PI/6), p1.y+size*Math.sin(ang+Math.PI/6));
  ctx.moveTo(p1.x,p1.y);
  ctx.lineTo(p1.x+size*Math.cos(ang-Math.PI/6), p1.y+size*Math.sin(ang-Math.PI/6));
  ctx.stroke();
}
function drawLabel(ctx, pos, text){
  const pad=10, t=text||''; const w=ctx.measureText(t).width+pad*2, h=38;
  const x=pos.x-w/2, y=pos.y-h/2;
  ctx.fillStyle='var(--label)'; ctx.strokeStyle='#333'; ctx.lineWidth=2;
  roundRect(ctx,x,y,w,h,8); ctx.fill(); ctx.stroke();
  ctx.fillStyle='var(--labelText)'; ctx.textBaseline='middle'; ctx.textAlign='center';
  ctx.fillText(t, x+w/2, y+h/2);
}
function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
function mid(a,b){ return {x:(a.x+b.x)/2, y:(a.y+b.y)/2}; }
function distToSegment(p,a,b){
  const l2=(b.x-a.x)**2+(b.y-a.y)**2; if(l2===0) return Math.hypot(p.x-a.x,p.y-a.y);
  let t=((p.x-a.x)*(b.x-a.x)+(p.y-a.y)*(b.y-a.y))/l2; t=Math.max(0,Math.min(1,t));
  const proj={x:a.x+t*(b.x-a.x),y:a.y+t*(b.y-a.y)}; return Math.hypot(p.x-proj.x,p.y-proj.y);
}
function hitTest(p){
  for(let i=shapes.length-1;i>=0;i--){
    const s=shapes[i];
    if(s.type==='dim'){ if(distToSegment(p,s.a,s.b)<18) return s.id; }
    else if(s.type==='text'){ if(Math.abs(p.x-s.pos.x)<80&&Math.abs(p.y-s.pos.y)<30) return s.id; }
  }
  return null;
}
function promptLabel(defaultText){
  const v=prompt('Valor/etiqueta (ej: 386 mm):', defaultText||''); return v==null?null:v;
}
function addShape(s){ s.id=(Date.now()+Math.random()).toString(36); shapes.push(s); draw(); }

function initAnnotator(){
  shapes=[]; activeId=null; dragStart=null; hoverId=null; draw();
  setTool('dim');

  const onDown=(e)=>{
    if(gesture.active) return; // si estamos pinch/zoom, ignorar
    const p=toCanvasPos(e); hoverId=hitTest(p); activeId=hoverId; dragStart=p;
    if(tool==='delete'){ if(activeId!=null){ shapes=shapes.filter(s=>s.id!==activeId); activeId=null; draw(); } return; }
    if(tool==='dim'){ addShape({type:'dim', a:p, b:p, label:''}); activeId=shapes[shapes.length-1].id; }
    else if(tool==='text'){ const val=promptLabel('Texto'); if(val!==null) addShape({type:'text', pos:p, label:val}); }
    e.preventDefault();
  };
  const onMove=(e)=>{
    if(gesture.active) return;
    const p=toCanvasPos(e);
    if(activeId!=null && dragStart){
      const s=shapes.find(x=>x.id===activeId); if(!s) return;
      if(s.type==='dim'){ s.b=p; draw(); }
    }else{
      hoverId=hitTest(p); draw();
    }
    e.preventDefault();
  };
  const onUp=(e)=>{
    if(gesture.active) return;
    if(activeId!=null){
      const s=shapes.find(x=>x.id===activeId);
      if(s?.type==='dim'){
        const val=promptLabel(s.label||''); if(val!==null) s.label=val;
      }
    }
    activeId=null; dragStart=null; draw();
    e.preventDefault();
  };

  paint.onpointerdown=onDown;
  paint.onpointermove=onMove;
  paint.onpointerup=onUp;
  paint.onpointerleave=onUp;

  // Doble click/tap para editar etiqueta del elemento bajo el dedo
  paint.addEventListener('dblclick', (e)=>{
    const p=toCanvasPos(e); const id=hitTest(p); if(id==null) return;
    const s=shapes.find(x=>x.id===id); const val=promptLabel(s.label||''); if(val!==null){ s.label=val; draw(); }
  });
}

/* ====== Pinch-to-zoom (dos dedos) en zoomLayer ====== */
const gesture = { active:false, scale:1, tx:0, ty:0, startDist:0, startCx:0, startCy:0, startTx:0, startTy:0, startScale:1 };
const pointers = new Map();
function setTransform(){ zoomLayer.style.transform = `translate(${gesture.tx}px, ${gesture.ty}px) scale(${gesture.scale})`; }
zoomLayer.addEventListener('pointerdown', (e)=>{ zoomLayer.setPointerCapture(e.pointerId); pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
  if(pointers.size===2){ const [p1,p2]=[...pointers.values()]; gesture.active=true;
    gesture.startDist=Math.hypot(p2.x-p1.x,p2.y-p1.y);
    gesture.startCx=(p1.x+p2.x)/2; gesture.startCy=(p1.y+p2.y)/2;
    gesture.startTx=gesture.tx; gesture.startTy=gesture.ty; gesture.startScale=gesture.scale; }
});
zoomLayer.addEventListener('pointermove', (e)=>{ if(!pointers.has(e.pointerId)) return; pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
  if(gesture.active && pointers.size===2){ const [p1,p2]=[...pointers.values()];
    const dist=Math.hypot(p2.x-p1.x,p2.y-p1.y), cx=(p1.x+p2.x)/2, cy=(p1.y+p2.y)/2;
    const ds=dist/gesture.startDist;
    gesture.scale=Math.min(3,Math.max(1,gesture.startScale*ds));
    gesture.tx=gesture.startTx+(cx-gesture.startCx); gesture.ty=gesture.startTy+(cy-gesture.startCy);
    setTransform(); }
},{passive:false});
function endPointer(e){ pointers.delete(e.pointerId); if(pointers.size<2){ gesture.active=false; } }
zoomLayer.addEventListener('pointerup', endPointer);
zoomLayer.addEventListener('pointercancel', endPointer);
zoomLayer.addEventListener('pointerleave', endPointer);

/* ====== Repetir / Guardar ====== */
btnRetake.addEventListener('click', async ()=>{
  editorArea.style.display='none'; cameraBar.style.display='flex';
  // reset zoom
  gesture.scale=1; gesture.tx=0; gesture.ty=0; setTransform();
  await startCamera();
});
btnSave.addEventListener('click', ()=>{
  if(!nombre.value.trim()){ alert('Pon un nombre a la foto.'); return; }
  const w=photo.naturalWidth, h=photo.naturalHeight;
  const out=document.createElement('canvas'); out.width=w; out.height=h;
  const ctx=out.getContext('2d');
  const img=new Image(); img.onload=()=>{
    ctx.drawImage(img,0,0,w,h);
    ctx.drawImage(paint,0,0);
    const png=out.toDataURL('image/png');
    dataurl.value=png; campoNombre.value=nombre.value.trim(); form.submit();
  }; img.src=photo.src;
});

/* Limpieza */
window.addEventListener('pagehide', stopStream);
window.addEventListener('beforeunload', stopStream);

/* Autoinicio */
document.addEventListener('DOMContentLoaded', ()=>{ startCamera().catch(()=>{}); });
</script>
{% endblock %}
