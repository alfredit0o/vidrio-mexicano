{% extends "base.html" %}
{% block content %}
<style>
  :root{
    --ink:#e9eef7; --muted:#9aa3b2; --panel:#121418; --panel2:#191e28; --accent:#4cc9f0;
    --label:#ffd400; --labelText:#111;
  }
  body{background:#0e0f12;color:var(--ink)}
  .wrap{max-width:560px;margin:16px auto;padding:8px}
  .title{margin:0 8px 6px}
  .hint{margin:0 8px 12px;color:var(--muted);text-align:center}
  .stage{position:relative;width:100%;aspect-ratio:4/3;background:#000;border-radius:14px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.35)}
  video, img, canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .reticle{position:absolute;left:50%;top:50%;width:140px;height:140px;transform:translate(-50%,-50%);border:2px solid rgba(255,255,255,.85);border-radius:14px;pointer-events:none}
  .bar{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:12px;background:var(--panel);border-radius:14px;padding:10px}
  .btn{border:1px solid #2b3242;background:#0f1218;color:var(--ink);border-radius:12px;padding:10px 14px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .shutter{width:64px;height:64px;border-radius:999px;border:4px solid #e9eef7;background:#e9eef7;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.35)}
  .row{display:flex;gap:8px;margin:10px 0}
  .row input{flex:1;padding:10px;border-radius:10px;border:1px solid #2b3242;background:#0f1218;color:var(--ink)}
  /* Toolbar dibujo */
  .tools{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px;background:var(--panel2);border-radius:14px;padding:8px}
  .tool{padding:8px 10px;border-radius:10px;border:1px solid #2b3242;background:#0f1218;color:var(--ink);cursor:pointer;font-size:.95rem}
  .tool.active{outline:2px solid var(--accent)}
  .legend{color:var(--muted);font-size:.9rem;text-align:center;margin-top:6px}
</style>

<div class="wrap">
  <h2 class="title">Capturar medida</h2>
  <p class="hint" id="status">Enmarca el vidrio y toca el bot√≥n.</p>

  <div class="stage" id="stage">
    <video id="video" autoplay playsinline muted></video>
    <img id="photo" alt="captura" style="display:none" />
    <canvas id="paint" style="display:none"></canvas> <!-- canvas de edici√≥n -->
    <div class="reticle" id="reticle"></div>
  </div>

  <div class="row">
    <input type="text" id="nombre" placeholder="Nombre de la foto" />
  </div>

  <h2 class="title">Capturar medida ‚Äî v2.1</h2>
<script>console.log("medidas_capture v2.1");</script>


  <!-- Controles de c√°mara -->
  <div class="bar" id="cameraBar">
    <button class="btn" id="btnStart">Iniciar</button>
    <button class="shutter" id="btnShot" title="Tomar foto" disabled></button>
    <button class="btn" id="btnFlip" disabled>Cambiar c√°mara</button>
  </div>

  <!-- Herramientas estilo Bosch (se muestran tras la captura) -->
  <div id="editorArea" style="display:none">
    <div class="tools">
      <button class="tool" data-tool="dim">‚Üî Flecha</button>
      <button class="tool" data-tool="rect">‚ñ† Superficie</button>
      <button class="tool" data-tool="angle">‚à† √Ångulo</button>
      <button class="tool" data-tool="text">T Texto</button>
      <button class="tool" data-tool="move">üñêÔ∏è Mover</button>
      <button class="tool" data-tool="delete">üóëÔ∏è Borrar</button>
      <button class="tool" data-tool="clear">‚ü≤ Limpiar</button>
    </div>
    <p class="legend" id="legend">Eleg√≠ una herramienta y toca en la imagen.</p>

    <div class="bar">
      <button class="btn" id="btnRetake">Repetir</button>
      <button class="btn" id="btnSave" disabled>Guardar</button>
    </div>
  </div>

  <form id="form" method="post" action="{{ url_for('medidas.new_post') }}" style="display:none">
    <input type="hidden" name="nombre"  id="campoNombre">
    <input type="hidden" name="dataurl" id="dataurl">
  </form>
</div>

<script>
/* ====== C√°mara: una sola activa ====== */
let stream=null, wakeLock=null, devices=[], envIds=[], userIds=[], currentList=[], idx=0, usingBack=true;
const $=id=>document.getElementById(id);
const video=$('video'), photo=$('photo'), paint=$('paint');
const btnStart=$('btnStart'), btnShot=$('btnShot'), btnFlip=$('btnFlip');
const btnRetake=$('btnRetake'), btnSave=$('btnSave');
const statusEl=$('status'), legendEl=$('legend');
const nombre=$('nombre'), campoNombre=$('campoNombre'), dataurl=$('dataurl'), form=$('form');
const cameraBar=$('cameraBar'), editorArea=$('editorArea');

function stopStream(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }
async function requestWakeLock(){ try{ if('wakeLock' in navigator){ wakeLock=await navigator.wakeLock.request('screen'); wakeLock.addEventListener('release',()=>{wakeLock=null}); } }catch(_){} }
async function enumerateCameras(){
  const list=await navigator.mediaDevices.enumerateDevices();
  devices=list.filter(d=>d.kind==='videoinput');
  envIds=[]; userIds=[];
  for(const d of devices){
    const isBack=d.label.toLowerCase().includes('back')||d.label.toLowerCase().includes('rear');
    const isFront=d.label.toLowerCase().includes('front');
    if(isBack) envIds.push(d.deviceId); else if(isFront) userIds.push(d.deviceId); else envIds.push(d.deviceId);
  }
  currentList=(usingBack&&envIds.length)?envIds:(userIds.length?userIds:devices.map(d=>d.deviceId));
  idx=0;
  btnFlip.disabled = devices.length<2; btnFlip.style.display=devices.length<2?'none':'inline-block';
}
async function startCameraById(deviceId){
  try{
    if(!navigator.mediaDevices?.getUserMedia){ alert('Requiere HTTPS o localhost'); return; }
    stopStream();
    const constraints={ video:{ deviceId:deviceId?{exact:deviceId}:undefined, facingMode: deviceId?undefined:{ideal:usingBack?'environment':'user'}, width:{ideal:1920}, height:{ideal:1080} }, audio:false };
    stream=await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject=stream; await video.play(); await requestWakeLock();
    // UI
    video.style.display='block'; photo.style.display='none'; paint.style.display='none';
    btnShot.disabled=false; statusEl.textContent='Enmarca el vidrio y toca el bot√≥n.';
  }catch(err){ console.error(err); alert('No se pudo iniciar la c√°mara: '+err.message); }
}
async function startCamera(){ await enumerateCameras(); const id=currentList[idx]||devices[0]?.deviceId||null; await startCameraById(id); }

btnStart.addEventListener('click', startCamera);
btnFlip.addEventListener('click', async ()=>{ if(!devices.length) await enumerateCameras(); idx=(idx+1)%currentList.length; await startCameraById(currentList[idx]); });

/* ====== Captura ‚Üí Editor ====== */
btnShot.addEventListener('click', async ()=>{
  if(!video.videoWidth){ alert('La c√°mara a√∫n no est√° lista.'); return; }
  // Congela frame como <img>
  const w=video.videoWidth, h=video.videoHeight;
  const tmp=document.createElement('canvas'); tmp.width=w; tmp.height=h;
  tmp.getContext('2d').drawImage(video,0,0,w,h);
  const png=tmp.toDataURL('image/png');
  photo.src=png;

  // Muestra editor
  video.style.display='none'; photo.style.display='block';
  cameraBar.style.display='none'; editorArea.style.display='block';
  paint.width=photo.naturalWidth; paint.height=photo.naturalHeight;
  paint.style.display='block';
  btnSave.disabled=false;

  stopStream(); if(wakeLock){ try{ await wakeLock.release(); }catch(_){} }
  statusEl.textContent='Arrastra para medir. Doble toque para editar valor.';
  // Inicializa motor de anotaci√≥n
  initAnnotator();
});

/* ====== Editor tipo Bosch (flecha, superficie, √°ngulo, texto) ====== */
let tool='dim', shapes=[], activeId=null, dragStart=null, hoverId=null;

function setLegend(){
  const map={
    dim:'‚Üî Arrastra dos puntos. Luego dobla/edita la etiqueta.',
    rect:'Arrastra un rect√°ngulo. Doble toque para editar texto.',
    angle:'Marca tres puntos (A, v√©rtice, B).',
    text:'Toca para colocar texto.',
    move:'Arrastra elementos para reposicionar.',
    delete:'Toca un elemento para borrarlo.',
    clear:'Limpia todas las anotaciones.'
  };
  legendEl.textContent=map[tool]||'';
}
function setTool(t){ tool=t; document.querySelectorAll('.tool').forEach(b=>b.classList.toggle('active', b.dataset.tool===t)); setLegend(); }
document.querySelectorAll('.tool').forEach(b=>{
  b.addEventListener('click', ()=>{
    const t=b.dataset.tool;
    if(t==='clear'){ shapes=[]; draw(); return; }
    setTool(t);
  });
});
setTool('dim');

function cx(){ return paint.getContext('2d'); }
function toCanvasPos(evt){
  const r=paint.getBoundingClientRect();
  const x=(evt.touches?evt.touches[0].clientX:evt.clientX)-r.left;
  const y=(evt.touches?evt.touches[0].clientY:evt.clientY)-r.top;
  const sx=paint.width/r.width, sy=paint.height/r.height;
  return {x:x*sx, y:y*sy};
}

function addLabelAt(shape, valueText){
  shape.label=valueText||shape.label||'';
}

function draw(){
  const ctx=cx(); ctx.clearRect(0,0,paint.width,paint.height);
  // Dibujo semivectorial encima de la foto
  shapes.forEach(s=>{
    ctx.save();
    ctx.lineWidth=4; ctx.strokeStyle='#ffe600'; ctx.fillStyle='#ffe600';
    ctx.font='32px system-ui, -apple-system, Segoe UI, Roboto';
    if(s.type==='dim'){
      // l√≠nea con puntas
      const {a,b}=s;
      ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
      drawArrow(ctx,a,b); drawArrow(ctx,b,a);
      drawLabel(ctx, mid(a,b), s.label||'');
    }else if(s.type==='rect'){
      const {x,y,w,h}=normRect(s);
      ctx.globalAlpha=0.15; ctx.fillRect(x,y,w,h);
      ctx.globalAlpha=1; ctx.strokeRect(x,y,w,h);
      drawLabel(ctx,{x:x+w/2,y:y+h/2},s.label||'');
    }else if(s.type==='angle'){
      const {a,o,b}=s;
      ctx.beginPath(); ctx.moveTo(o.x,o.y); ctx.lineTo(a.x,a.y); ctx.moveTo(o.x,o.y); ctx.lineTo(b.x,b.y); ctx.stroke();
      const ang = Math.abs(angle(a,o,b)).toFixed(1)+'¬∞';
      drawLabel(ctx,o,s.label||ang);
    }else if(s.type==='text'){
      drawLabel(ctx,s.pos,s.label||'Texto');
    }
    ctx.restore();
  });
  // hover
  if(hoverId!=null){
    const s=shapes.find(x=>x.id===hoverId); if(!s) return;
    const ctx=cx(); ctx.save(); ctx.strokeStyle='#4cc9f0'; ctx.lineWidth=3;
    if(s.type==='rect'){ const {x,y,w,h}=normRect(s); ctx.strokeRect(x,y,w,h); }
    else if(s.type==='dim'){ ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke(); }
    else if(s.type==='angle'){ ctx.beginPath(); ctx.arc(s.o.x,s.o.y,28,0,Math.PI*2); ctx.stroke(); }
    else if(s.type==='text'){ /* no-op */ }
    ctx.restore();
  }
}
function drawArrow(ctx, p1, p2){
  const ang=Math.atan2(p2.y-p1.y,p2.x-p1.x), size=14;
  ctx.beginPath();
  ctx.moveTo(p1.x,p1.y);
  ctx.lineTo(p1.x+size*Math.cos(ang+Math.PI/6), p1.y+size*Math.sin(ang+Math.PI/6));
  ctx.moveTo(p1.x,p1.y);
  ctx.lineTo(p1.x+size*Math.cos(ang-Math.PI/6), p1.y+size*Math.sin(ang-Math.PI/6));
  ctx.stroke();
}
function drawLabel(ctx, pos, text){
  const pad=10; const t=text||'';
  const metrics=ctx.measureText(t); const w=metrics.width+pad*2; const h=38;
  const x=pos.x-w/2, y=pos.y-h/2;
  ctx.fillStyle='var(--label)'; ctx.strokeStyle='#333'; ctx.lineWidth=2;
  roundRect(ctx,x,y,w,h,8); ctx.fill(); ctx.stroke();
  ctx.fillStyle='var(--labelText)'; ctx.textBaseline='middle'; ctx.textAlign='center';
  ctx.fillText(t, x+w/2, y+h/2);
}
function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
function mid(a,b){ return {x:(a.x+b.x)/2, y:(a.y+b.y)/2}; }
function angle(a,o,b){
  const v1={x:a.x-o.x,y:a.y-o.y}, v2={x:b.x-o.x,y:b.y-o.y};
  const dot=v1.x*v2.x+v1.y*v2.y;
  const mag1=Math.hypot(v1.x,v1.y), mag2=Math.hypot(v2.x,v2.y);
  return Math.acos(Math.max(-1,Math.min(1,dot/(mag1*mag2))))*180/Math.PI;
}
function normRect(s){ const x=Math.min(s.a.x,s.b.x), y=Math.min(s.a.y,s.b.y); const w=Math.abs(s.a.x-s.b.x), h=Math.abs(s.a.y-s.b.y); return {x,y,w,h}; }

function hitTest(p){
  // selecci√≥n simple por proximidad
  for(let i=shapes.length-1;i>=0;i--){
    const s=shapes[i];
    if(s.type==='dim'){
      const d=distToSegment(p,s.a,s.b); if(d<18) return s.id;
    }else if(s.type==='rect'){
      const {x,y,w,h}=normRect(s); if(p.x>=x&&p.x<=x+w&&p.y>=y&&p.y<=y+h) return s.id;
    }else if(s.type==='angle'){
      const r=32; if(Math.hypot(p.x-s.o.x,p.y-s.o.y)<r) return s.id;
    }else if(s.type==='text'){
      // aproximado: caja 140x40 centrada
      if(Math.abs(p.x-s.pos.x)<80&&Math.abs(p.y-s.pos.y)<30) return s.id;
    }
  }
  return null;
}
function distToSegment(p,a,b){
  const l2=(b.x-a.x)**2+(b.y-a.y)**2; if(l2===0) return Math.hypot(p.x-a.x,p.y-a.y);
  let t=((p.x-a.x)*(b.x-a.x)+(p.y-a.y)*(b.y-a.y))/l2; t=Math.max(0,Math.min(1,t));
  const proj={x:a.x+t*(b.x-a.x),y:a.y+t*(b.y-a.y)}; return Math.hypot(p.x-proj.x,p.y-proj.y);
}

/* interacci√≥n */
function promptLabel(defaultText){
  const v=prompt('Valor/etiqueta (ej: 386 mm):', defaultText||''); return v==null?null:v;
}
function addShape(s){ s.id=(Date.now()+Math.random()).toString(36); shapes.push(s); draw(); }

function initAnnotator(){
  shapes=[]; activeId=null; dragStart=null; hoverId=null; draw();
  setTool('dim');

  let angleStep=0; // para herramienta √°ngulo: 0=A,1=O,2=B

  const onDown=(e)=>{
    const p=toCanvasPos(e); hoverId=hitTest(p); activeId=hoverId; dragStart=p;
    if(tool==='delete'){ if(activeId!=null){ shapes=shapes.filter(s=>s.id!==activeId); activeId=null; draw(); } return; }
    if(tool==='move'){ return; }

    if(tool==='dim'){ addShape({type:'dim', a:p, b:p, label:'‚Üî'}); activeId=shapes[shapes.length-1].id; }
    else if(tool==='rect'){ addShape({type:'rect', a:p, b:p, label:'Superficie'}); activeId=shapes[shapes.length-1].id; }
    else if(tool==='angle'){
      if(angleStep===0){ addShape({type:'angle', a:p, o:p, b:p}); activeId=shapes[shapes.length-1].id; angleStep=1; legendEl.textContent='Marca el v√©rtice'; }
      else if(angleStep===1){ const s=shapes.find(x=>x.id===activeId); s.o=p; angleStep=2; legendEl.textContent='Marca el segundo punto'; draw(); }
      else { const s=shapes.find(x=>x.id===activeId); s.b=p; angleStep=0; const val=promptLabel(Math.abs(angle(s.a,s.o,s.b)).toFixed(1)+' ¬∞'); if(val!==null) s.label=val; draw(); }
    }
    else if(tool==='text'){ const val=promptLabel('Texto'); if(val!==null) addShape({type:'text', pos:p, label:val}); }
    e.preventDefault();
  };
  const onMove=(e)=>{
    const p=toCanvasPos(e);
    if(tool==='move'){
      if(activeId!=null && dragStart){ // arrastra todo el shape
        const s=shapes.find(x=>x.id===activeId); if(!s) return;
        const dx=p.x-dragStart.x, dy=p.y-dragStart.y; dragStart=p;
        if(s.type==='dim'){ s.a.x+=dx; s.a.y+=dy; s.b.x+=dx; s.b.y+=dy; }
        else if(s.type==='rect'){ s.a.x+=dx; s.a.y+=dy; s.b.x+=dx; s.b.y+=dy; }
        else if(s.type==='angle'){ s.a.x+=dx; s.a.y+=dy; s.o.x+=dx; s.o.y+=dy; s.b.x+=dx; s.b.y+=dy; }
        else if(s.type==='text'){ s.pos.x+=dx; s.pos.y+=dy; }
        draw(); return;
      }
    }
    if(activeId!=null && dragStart){
      const s=shapes.find(x=>x.id===activeId); if(!s) return;
      if(s.type==='dim'){ s.b=p; }
      else if(s.type==='rect'){ s.b=p; }
      draw();
    }else{
      hoverId=hitTest(p); draw();
    }
    e.preventDefault();
  };
  const onUp=(e)=>{
    if(activeId!=null){
      const s=shapes.find(x=>x.id===activeId);
      if(s?.type==='dim'){ const val=promptLabel(s.label&&s.label!=='‚Üî'?s.label:''); if(val!==null) s.label=val||s.label; }
      if(s?.type==='rect'){ const val=promptLabel(s.label); if(val!==null) s.label=val; }
    }
    activeId=null; dragStart=null; draw();
    e.preventDefault();
  };
  paint.onpointerdown=onDown;
  paint.onpointermove=onMove;
  paint.onpointerup=onUp;
  paint.onpointerleave=onUp;
}

/* ====== Repetir / Guardar ====== */
btnRetake.addEventListener('click', async ()=>{
  editorArea.style.display='none'; cameraBar.style.display='flex';
  await startCamera();
});

btnSave.addEventListener('click', ()=>{
  if(!nombre.value.trim()){ alert('Pon un nombre a la foto.'); return; }
  // Render final: foto + shapes -> PNG
  const w=photo.naturalWidth, h=photo.naturalHeight;
  const out=document.createElement('canvas'); out.width=w; out.height=h;
  const ctx=out.getContext('2d');
  const img=new Image(); img.onload=()=>{
    ctx.drawImage(img,0,0,w,h);
    // copiar overlay
    ctx.drawImage(paint,0,0);
    const png=out.toDataURL('image/png');
    dataurl.value=png;
    campoNombre.value=nombre.value.trim();
    form.submit();
  };
  img.src=photo.src;
});

/* Limpieza */
window.addEventListener('pagehide', stopStream);
window.addEventListener('beforeunload', stopStream);

/* Autoinicio (si el navegador lo permite) */
document.addEventListener('DOMContentLoaded', ()=>{ startCamera().catch(()=>{}); });
</script>
{% endblock %}
